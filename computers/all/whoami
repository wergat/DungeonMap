os.loadAPI(":dungeon/dcore/apis/dcore")
local tArgs = {...}
local init = false
if(tArgs[1])then
	print("This is the first run, initializing!")
	init = true
	local open = fs.open(":startup","w")
	open.write("shell.run(\"dungeon/computers/all/whoami\")")
	open.close()
end
local x,y,z = commands.getBlockPosition()
local block = commands.getBlockInfo(x,y-1,z)
print("No special block data found in mods, looking for native versions")

	
local l = fs.list(config.DIR_MODS)
-- BIOS informations
-- Can be used in case of emergency
print("Searching for valid startup file. Press any button to cancle!")
os.startTimer(.5)
local tEvent = {os.pullEvent()}
print(tEvent[1])
print("Continuing the booting process.")


-- Starting Who-Am-I Events in mods and stuff
for i=1,#l do
	-- l[i] = Modname
	local pathToAPIFile = config.DIR_MODS.."/"..l[i].."/event/whoami"
	if(fs.exists(pathToAPIFile))then
		dcore.print_log("dcore","[EVENT][whoami]["..l[i].."] Starting "..pathToAPIFile.."")
		local tEnv = setmetatable({block = block,init = init}, { __index = _ENV } )
		local fnAPI, err = loadfile(pathToAPIFile)
		if fnAPI then
			setfenv( fnAPI, tEnv )
			local ok, err = pcall( fnAPI )
			if not ok then
				dcore.print_log("error","[EVENT][whoami]["..l[i].."] While loading "..pathToAPIFile.."; "..err)
				if(firstError)then
					if(term.isColor())then term.setTextColor(colors.red) end
					print("error found while loading api files, check logs/error for more informations! "..err)
					term.setTextColor(colors.white)
					firstError = false
				end
			end
		else
			dcore.print_log("error","[EVENT][whoami]["..l[i].."] While loading "..pathToAPIFile.."; ")
			if(firstError)then
				if(term.isColor())then term.setTextColor(colors.red) end
				print("error found while loading api files, check logs/error for more informations! "..err)
				term.setTextColor(colors.white)
				firstError = false
			end
		end
	end
end


-- Check for mobile computer
if(pocket)then
end




-- Main Computer
if(block.name == "minecraft:quartz_block")then
	print("Identified as Dev Computer")
	if(init)then
		print("Updating")
		sleep(1)
		local update = shell.run("dungeon/computers/all/update","https://api.github.com/repos/wergat/DungeonMap/contents/")
		if(not update)then printError("Update File not found!") end
		sleep(1)
		os.reboot()
	else
		print("Running main function")
		shell.run("dungeon/computers/dev/main")
	end
end


-- Settings monitor
if(block.name == "minecraft:wool")then
	shell.run("dungeon/computers/all/update","https://api.github.com/repos/wergat/DungeonMap/contents/dcore/","https://api.github.com/repos/wergat/DungeonMap/contents/computers/option","https://api.github.com/repos/wergat/DungeonMap/contents/computers/all","https://api.github.com/repos/wergat/DungeonMap/contents/mods/")
	if(init)then
		sleep(1)
		os.reboot()
	end
	local side = nil
	for k,v in pairs(peripheral.getNames()) do
		if(peripheral.getType(v))then
			side = v
		end
	end
	if(side)then
		shell.run("monitor "..side.." dungeon/computers/option/main")
	end
end

-- cmd_salve
if(block.name == "minecraft:iron_block")then
	local update = shell.run("dungeon/computers/all/update","https://api.github.com/repos/wergat/DungeonMap/contents/dcore/apis/github","https://api.github.com/repos/wergat/DungeonMap/contents/computers/all","https://api.github.com/repos/wergat/DungeonMap/contents/computers/cmd_slave","https://api.github.com/repos/wergat/DungeonMap/contents/dcore/apis/dcore")
	if(not update)then print("Update File not found!") end
	shell.run("dungeon/computers/cmd_slave/main")
end
